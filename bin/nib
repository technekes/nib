#!/bin/bash
#
#/* vim: set filetype=sh : */

show_help() {
  echo "Usage: nib COMMAND [OPTIONS] [arg...]

Run docker/compose commands on apps relative to the current directory

Options:
  -h, --help      Print usage
      --version   Print version information

$(print_commands)

Run 'nib COMMAND --help' for more information on a command.

Note:
  Unrecognized commands will be delegate to docker-compose

  For example the following are equivalent:
    nib start
    docker-compose start"
}

DIR=/usr/local/bin
source "$DIR/_help"

is_wrapped_command() {
  query=".[] | select( .name == \"$1\" ) | select( .type == \"wrap\" )"

  if [[ $(cat $DIR/config/commands.json | jq -r "$query") ]]; then
    return 0
  else
    return 1
  fi
}

if [[ $# -eq 0 ]] ; then
  show_help
  exit 0
elif [ -f "$DIR/$1" ]; then
  $DIR/$@
elif is_wrapped_command $1 ; then
  $DIR/wrap_command $@
else
  docker-compose $@
fi
